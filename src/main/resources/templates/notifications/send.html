<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
	layout:decorator="layout">
<head>
    <title>发送通知</title>
    <meta charset="utf-8" />
</head>
<body>
	<h1 layout:fragment="header">发送通知</h1>
	
	<div layout:fragment="content" class="container">
		<form method="POST" th:action="@{/notifications/}" class="form-validation">
			<div class="form-group">
                <input type="text" name="title" class="form-control" placeholder="Title" autofocus="autofocus" />
            </div>
	        <div class="form-group">
                <textarea rows="2" cols="10" name="content" class="form-control" placeholder="正文内容"></textarea>
            </div>
			<button id="btn-submit" class="btn btn-lg btn-primary btn-block" type="button" onclick="send()">Submit</button>
		</form>
	</div>
</body>
<script type="text/javascript" layout:fragment="javascript_block">
//<![CDATA[
$(function(){
	// validate signup form on keyup and submit
	$(".form-validation").validate({
		success: "valid",
        submitHandler: function(form) {
        	return formSubmitHandler(form);
        },
		rules: {
			title: {
				required: true,
				minlength: 2
			},
			content: {
				required: true
			}
		},
		messages: {
			title: {
				required: "Please enter a title",
				minlength: "Your name must consist of at least 2 characters"
			},
			content: {
				required: "输入正文内容"
			}
		}
	});
});

function formSubmitHandler(form) {
    var btnSubmitText = $('#btn-submit').html();

    $(".form-validation").ajaxSubmit({
      beforeSubmit: function() {
        // disabled the button
        $('#btn-submit').prop('disabled', true);
        $('#btn-submit').append("中...");
      },
      success: function (response) {
    	  location.href = "/roles/" + response;
      },
      error: function(xhr, status, error) {
    	  //status: error
    	  //error: Not Acceptable
    	  //xhr.status: 401
    	  
          // re-enable the button
          $('#btn-submit').prop('disabled', false);
          $('#btn-submit').html(btnSubmitText);
      }
    });
    return false;
}

// ============== notify with web socket ==================
var websocket = null;  

//判断当前浏览器是否支持WebSocket
if ('WebSocket' in window) {  
    websocket = new WebSocket("ws://localhost:8080/messageSocket");  
} else {
    alert('Not support websocket')  
}
	
//连接发生错误的回调方法  
websocket.onerror = function () {
    // popupNotification("error");  
};  

//连接成功建立的回调方法  
websocket.onopen = function (event) {
    // popupNotification("open a socket connetion");  
}  

//接收到消息的回调方法  
websocket.onmessage = function (event) {
    popupNotification(event.data);  
}  

//连接关闭的回调方法  
websocket.onclose = function () {
    // popupNotification("close a socket connetion");  
}  

//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。  
window.onbeforeunload = function () {
    websocket.close();
}

//关闭连接  
function closeWebSocket() {
    websocket.close();  
}  

//发送消息 
function send() {
    var message = $('[name="content"]').val();
    websocket.send(message);  
}

//======================= 弹出窗口
$(function() {
  // 首先，让我们检查我们是否有权限发出通知
  // 如果没有，我们就请求获得权限
  if (window.Notification !== null && Notification.permission !== "granted" ) {
    Notification.requestPermission(function (status) {
      if (Notification.permission !== status) {
        Notification.permission = status;
      }
    });
  }
});

function popupNotification(message) {
    // 如果用户同意就创建一个通知
    if (window.Notification !== null && Notification.permission === "granted" ) {
      var n = new Notification(message);
    }

    // 如果用户没有选择是否显示通知
    // 注：因为在 Chrome 中我们无法确定 permission 属性是否有值，因此
    // 检查该属性的值是否是 "default" 是不安全的。
    else if (window.Notification !== null && Notification.permission !== "denied") {
      Notification.requestPermission(function (status) {
        if (Notification.permission !== status) {
          Notification.permission = status;
        }

        // 如果用户同意了
        if (status === "granted") {
          var n = new Notification(message);
        }

        // 否则，我们可以让步的使用常规模态的 alert
        else {
          alert(message);
        }
      });
    }
    // 如果用户拒绝接受通知
    else {
      // 我们可以让步的使用常规模态的 alert
      alert(message);
   }
}
//]]>
</script>
</html>